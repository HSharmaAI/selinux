---
- name: Test all the possible selinux_state transitions
  hosts: all
  tags:
    - tests::reboot
  vars:
    states:
      - permissive
      - enforcing
      - disabled

  tasks:
    - name: Check if test is supported
      vars:
        ostree_booted_file: /run/ostree-booted
      block:
        - name: Check if system is ostree
          stat:
            path: "{{ ostree_booted_file }}"
          register: __ostree_booted_stat

        - name: Skip if not supported
          meta: end_host
          when: __ostree_booted_stat.stat.exists

    - name: Include test variables
      import_tasks: set_selinux_variables.yml

    - name: Save config
      include_tasks: selinux_config_save.yml

    - name: Get selinux facts
      setup:
        filter: ansible_selinux

    - name: Save selinux state before test
      set_fact:
        __state_before: "{{ ansible_selinux.mode | d(ansible_selinux.status) }}"
        __type_before: "{{ ansible_selinux.type }}"

    - name: See if we can use update_kernel_param
      set_fact:
        __test_update_kernel_param: "{{ ansible_facts['os_family'] == 'RedHat' and
          ansible_facts['distribution_major_version'] is version('8', '>=') and
          ansible_version.full is version('2.10', '>=') }}"

    # First test non-reboot transitions (permissive <-> enforcing)
    - name: Test non-reboot transitions
      include_tasks: selinux_test_transitions.yml
      vars:
        selinux_initial_state: "{{ item.0 }}"
        selinux_desired_state: "{{ item.1 }}"
      with_nested:
        - ["permissive", "enforcing"]
        - ["permissive", "enforcing"]
      when: item.0 != item.1  # Skip same-state transitions

    # Then test transitions involving disabled state
    - name: Test transitions to disabled
      include_tasks: selinux_test_transitions.yml
      vars:
        selinux_initial_state: "{{ item.0 }}"
        selinux_desired_state: "{{ item.1 }}"
      with_nested:
        - ["permissive", "enforcing"]
        - ["disabled"]
      when: item.0 != item.1  # Skip same-state transitions

    - name: Disable selinux and set kernel
      ansible.posix.selinux:
        state: disabled
        update_kernel_param: "{{ true if __test_update_kernel_param else omit }}"
      register: __disable_result

    - name: Add selinux=0 to kernel args (RHEL)
      when:
        - not __test_update_kernel_param
        - __disable_result.reboot_required
        - ansible_distribution not in ['SLES', 'SUSE']  # Skip on SLES/SUSE
      include_role:
        name: fedora.linux_system_roles.bootloader
      vars:
        bootloader_settings:
          - kernel: ALL
            options:
              - name: selinux
                value: "0"
                state: present

    - name: Add selinux=0 to kernel args (SLES)
      when:
        - not __test_update_kernel_param
        - __disable_result.reboot_required
        - ansible_distribution in ['SLES', 'SUSE']
      command: transactional-update run grub2-mkconfig -o /boot/grub2/grub.cfg
      register: __sles_grub_update

    - name: Show __disable_result
      debug:
        msg: __disable_result is {{ __disable_result | to_nice_json }}

    - name: Reboot if needed
      reboot:
        msg: "Rebooting to apply SELinux state change"
        pre_reboot_delay: 2
        post_reboot_delay: 10
        reboot_timeout: 300
      when: __disable_result.reboot_required

    # After reboot, test transitions from disabled
    - name: Test transitions from disabled
      include_tasks: selinux_test_transitions.yml
      vars:
        selinux_initial_state: "disabled"
        selinux_desired_state: "{{ item }}"
      with_items: ["permissive", "enforcing"]
      when: __disable_result.reboot_required

    - name: Restore config
      include_tasks: selinux_config_restore.yml

    - name: Re-enable selinux and set kernel if disabled
      ansible.posix.selinux:
        state: "{{ __state_before }}"
        policy: "{{ __type_before }}"
        update_kernel_param: "{{ true if ansible_facts['os_family'] == 'RedHat' and
          ansible_facts['distribution_major_version'] is version('8', '>=')
          else omit }}"
      register: __enable_result
      when: __disable_result.reboot_required

    - name: Remove selinux=0 from kernel args (RHEL)
      when:
        - not __test_update_kernel_param
        - __enable_result.reboot_required
        - ansible_distribution not in ['SLES', 'SUSE']  # Skip on SLES/SUSE
      include_role:
        name: fedora.linux_system_roles.bootloader
      vars:
        bootloader_settings:
          - kernel: ALL
            options:
              - name: selinux
                value: "0"
                state: absent

    - name: Remove selinux=0 from kernel args (SLES)
      when:
        - not __test_update_kernel_param
        - __enable_result.reboot_required
        - ansible_distribution in ['SLES', 'SUSE']
      command: transactional-update run grub2-mkconfig -o /boot/grub2/grub.cfg
      register: __sles_grub_update_restore

    - name: Final reboot if needed
      reboot:
        msg: "Rebooting to restore original SELinux state"
        pre_reboot_delay: 2
        post_reboot_delay: 10
        reboot_timeout: 300
      when: __enable_result.reboot_required
